<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>UNM Cafeteria – Food Shops</title>
	<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='6' y='6' width='52' height='52' rx='12' ry='12' fill='%23fff' stroke='%23f97316' stroke-width='2'/%3E%3Cpath fill='%23f97316' d='M18 14c4.2 0 7.6 3.4 7.6 7.6 0 3.2-1.8 6-4.6 7.1V46h-6V28.7c-2.8-1.1-4.6-3.9-4.6-7.1C10.4 17.4 13.8 14 18 14z'/%3E%3Cpath fill='%23ea580c' d='M34 14h4v10h2V14h4v10h2V14h4v12h-6v20h-6V26h-6z'/%3E%3C/svg%3E" />
	<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--orange: #f97316;
			--orange-dark: #ea580c;
			--black: #0f172a;
			--gray: #f8fafc;
			--border: #e2e8f0;
			--panel: #ffffff;
			--shadow: 0 8px 18px rgba(0,0,0,0.06);
		}
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: 'Inter', 'Segoe UI', Tahoma, Arial, sans-serif;
			background: #ffffff;
			color: var(--black);
			min-height: 100vh;
			padding-bottom: 32px;
			-webkit-font-smoothing: antialiased;
		}
		.page {
			max-width: 1180px;
			margin: 0 auto;
			padding: 12px clamp(12px, 3vw, 20px) 32px clamp(12px, 3vw, 20px);
			display: grid;
			gap: 12px;
		}
		.topbar {
			position: static;
			margin: 0 -4px;
			padding: 6px 8px;
			background: #ffffff;
			border-bottom: 1px solid var(--border);
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
			border-radius: 0 0 8px 8px;
			display: grid;
			gap: 10px;
		}
		.hero {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 8px;
			align-items: center;
			background: #ffffff;
			border: 1px solid var(--border);
			border-radius: 10px;
			padding: 8px 10px;
			box-shadow: 0 4px 12px rgba(0,0,0,0.05);
		}
		.hero-main { display: grid; gap: 4px; align-content: center; }
		.brand {
			display: flex;
			gap: 10px;
			align-items: center;
			font-weight: 800;
			color: var(--orange-dark);
			letter-spacing: 0.45px;
		}
		.hero h1 {
			margin: 0;
			font-size: clamp(1.2rem, 3.2vw, 1.55rem);
			letter-spacing: 0.45px;
			color: var(--orange-dark);
		}
		.quote-chip { display: none; }
		.actions { display: flex; gap: 8px; align-items: center; justify-content: flex-end; }
		.profile {
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 6px;
			border-radius: 12px;
			background: var(--gray);
			border: 1px solid var(--border);
			box-shadow: 0 2px 8px rgba(0,0,0,0.04);
			cursor: pointer;
			min-width: 48px;
			transition: transform 0.12s ease, box-shadow 0.16s ease;
		}
		.profile:active { transform: translateY(1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
		.profile .profile-badge {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			background: var(--orange);
			display: grid;
			place-items: center;
			color: #ffffff;
			font-weight: 800;
			letter-spacing: 0.4px;
			border: 1px solid rgba(0,0,0,0.04);
			box-shadow: 0 8px 18px rgba(0,0,0,0.12);
		}
		.filters {
			position: sticky;
			top: 0;
			z-index: 24;
			display: grid;
			gap: 6px;
			background: #ffffff;
			padding: 8px 10px;
			border-radius: 10px;
			border: 1px solid var(--border);
			box-shadow: 0 3px 10px rgba(0,0,0,0.05);
		}
		.filter-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }
		.filter-box {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 6px 10px;
			border-radius: 10px;
			border: 1px solid var(--border);
			background: #ffffff;
			box-shadow: 0 4px 12px rgba(0,0,0,0.04);
			color: var(--black);
		}
		.input, select {
			width: 100%;
			padding: 12px 14px;
			border-radius: 14px;
			border: 1px solid var(--border);
			background: #ffffff;
			color: var(--black);
			font-size: 1rem;
			outline: none;
			box-shadow: var(--shadow);
			transition: border 0.15s, box-shadow 0.2s, transform 0.1s ease;
		}
		.input::placeholder { color: #94a3b8; font-weight: 600; }
		select option { color: var(--black); background: #ffffff; }
		.input:focus, select:focus {
			border-color: var(--orange);
			box-shadow: 0 0 0 6px rgba(249,115,22,0.14);
			transform: translateY(-1px);
		}
		.grid {
			margin-top: 16px;
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
			gap: 14px;
		}
		.card {
			position: relative;
			background: #ffffff;
			border: 1px solid var(--border);
			border-radius: 14px;
			overflow: hidden;
			box-shadow: 0 6px 16px rgba(0,0,0,0.06);
			display: grid;
			grid-template-rows: auto 1fr;
			min-height: 300px;
			transition: transform 0.12s ease, box-shadow 0.18s ease, border-color 0.18s ease;
		}
		.card:hover { transform: translateY(-3px); border-color: var(--orange); box-shadow: 0 10px 26px rgba(0,0,0,0.1); }
		.card img {
			width: 100%;
			height: auto;
			aspect-ratio: 16 / 9;
			object-fit: cover;
			display: block;
			background: #f8fafc;
			margin-top: 8px;
		}
		.card-body { padding: 14px; display: grid; gap: 10px; }
		.card-head { display: flex; gap: 10px; align-items: center; }
		.card h3 { margin: 0; font-size: 1.08rem; letter-spacing: 0.2px; flex: 1; color: var(--black); }
		.status { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 0.9rem; border: 1px solid transparent; }
		.status.open { background: #dcfce7; color: #166534; border-color: #86efac; }
		.status.closed { background: #fee2e2; color: #b91c1c; border-color: #fecdd3; }
		.card p { margin: 0; color: #475569; line-height: 1.5; font-size: 0.95rem; }
		.card-foot { display: flex; align-items: center; justify-content: space-between; }
		.cta { padding: 10px 12px; border-radius: 12px; border: 1px solid var(--orange); background: var(--orange); color: #ffffff; font-weight: 800; letter-spacing: 0.3px; }
		.fav-btn { position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: #ffffff; display: grid; place-items: center; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.08); }
		.fav-btn svg { width: 22px; height: 22px; fill: none; stroke: #94a3b8; stroke-width: 2.1; transition: fill 0.18s, stroke 0.18s; }
		.fav-btn.fav svg { fill: #ef4444; stroke: #ef4444; }
		.loader-wrap { width: 100%; display: flex; align-items: center; justify-items: center; justify-content: center; padding: 18px 0 10px 0; gap: 12px; }
		.dot-loader { display: inline-flex; gap: 8px; }
		.dot-loader span { width: 12px; height: 12px; border-radius: 50%; background: var(--orange); animation: floatDots 1s ease-in-out infinite; }
		.dot-loader span:nth-child(2) { animation-delay: 0.16s; }
		.dot-loader span:nth-child(3) { animation-delay: 0.32s; }
		@keyframes floatDots { 0%,80%,100%{transform:translateY(0);opacity:0.6;} 40%{transform:translateY(-6px);opacity:1;} }
		.page-loader {
			position: fixed;
			inset: 0;
			display: none;
			align-items: center;
			justify-content: center;
			gap: 12px;
			background: rgba(255,255,255,0.82);
			backdrop-filter: blur(6px);
			z-index: 50;
			color: var(--black);
			font-weight: 800;
			letter-spacing: 0.3px;
		}
		.page-loader .spinner {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			border: 4px solid rgba(255,255,255,0.7);
			border-top-color: var(--orange);
			animation: spin 0.8s linear infinite;
			box-shadow: 0 8px 20px rgba(0,0,0,0.08);
		}
		@keyframes spin { to { transform: rotate(360deg); } }
		.skeleton { position: relative; border-radius: 14px; border: 1px solid var(--border); background: var(--panel); overflow: hidden; min-height: 300px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
		.sk-img, .sk-line, .sk-pill {
			background: linear-gradient(90deg, rgba(0,0,0,0.04) 0%, rgba(0,0,0,0.08) 50%, rgba(0,0,0,0.04) 100%);
			background-size: 200% 100%;
			animation: shimmer 1.2s ease-in-out infinite;
		}
		.sk-img { height: 160px; }
		.sk-body { padding: 14px; display: grid; gap: 10px; }
		.sk-line { height: 14px; border-radius: 10px; }
		.sk-pill { height: 22px; width: 120px; border-radius: 999px; }
		@keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
		.empty { grid-column: 1 / -1; text-align: center; padding: 24px 14px; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; color: #475569; }

		/* Dark mode overrides */
		body.dark-mode { background: #0b1220; color: #e2e8f0; }
		body.dark-mode .topbar,
		body.dark-mode .hero,
		body.dark-mode .filters,
		body.dark-mode .filter-box { background: #0f172a; border-color: #1f2937; box-shadow: 0 4px 14px rgba(0,0,0,0.35); }
		body.dark-mode .hero { box-shadow: 0 6px 18px rgba(0,0,0,0.3); }
		body.dark-mode .brand,
		body.dark-mode .hero h1 { color: #fbbf24; }
		body.dark-mode .profile { background: #0b1325; border-color: #1f2937; box-shadow: 0 4px 12px rgba(0,0,0,0.35); }
		body.dark-mode .profile .profile-badge { background: #f97316; color: #ffffff; }
		body.dark-mode .input,
		body.dark-mode select { background: #0b1325; border-color: #1f2937; color: #e2e8f0; box-shadow: 0 6px 16px rgba(0,0,0,0.35); }
		body.dark-mode .input::placeholder { color: #94a3b8; }
		body.dark-mode select option { background: #0b1325; color: #e2e8f0; }
		body.dark-mode .input:focus,
		body.dark-mode select:focus { border-color: #f97316; box-shadow: 0 0 0 6px rgba(249,115,22,0.22); }
		body.dark-mode .grid { gap: 14px; }
		body.dark-mode .card { background: #0f172a; border-color: #1f2937; box-shadow: 0 10px 28px rgba(0,0,0,0.35); }
		body.dark-mode .card h3 { color: #e2e8f0; }
		body.dark-mode .card p { color: #cbd5e1; }
		body.dark-mode .status.open { background: rgba(34,197,94,0.18); color: #34d399; border-color: rgba(52,211,153,0.4); }
		body.dark-mode .status.closed { background: rgba(239,68,68,0.18); color: #fca5a5; border-color: rgba(248,113,113,0.35); }
		body.dark-mode .cta { background: #f97316; border-color: #fb923c; color: #ffffff; box-shadow: 0 8px 18px rgba(249,115,22,0.25); }
		body.dark-mode .fav-btn { background: #0b1325; border-color: #1f2937; box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
		body.dark-mode .fav-btn svg { stroke: #cbd5e1; }
		body.dark-mode .fav-btn.fav svg { stroke: #ef4444; fill: #ef4444; }
		body.dark-mode .empty { background: #0f172a; border-color: #1f2937; color: #cbd5e1; }
		body.dark-mode .page-loader { background: rgba(5,10,18,0.75); color: #e2e8f0; }
		body.dark-mode .page-loader .spinner { border-color: rgba(255,255,255,0.25); border-top-color: #f97316; box-shadow: 0 8px 20px rgba(0,0,0,0.35); }
		body.dark-mode .dot-loader span { background: #f97316; }
		@media (max-width: 880px) { .hero { grid-template-columns: 1fr; align-items: start; } .actions { width: auto; } }
		@media (max-width: 620px) {
			.grid { grid-template-columns: 1fr; }
				.card { grid-template-rows: auto 1fr; }
			.filter-row { flex-direction: column; align-items: flex-start; }
			.filter-box { width: 100%; }
		}
		@media (max-width: 720px) {
				.page { padding: 10px 10px 24px 10px; }
				.topbar { margin: 0 -6px; padding: 6px 8px; box-shadow: none; border-bottom: none; }
				.filters { order: 1; top: 0; }
				.hero { order: 2; padding: 8px 10px; border-radius: 10px; box-shadow: none; border: none; position: relative; padding-right: 70px; }
				.actions { position: absolute; top: 6px; right: 8px; }
				.grid { gap: 12px; }
		}
		@media (max-width: 540px) {
			.topbar { padding: 6px 6px; box-shadow: 0 3px 8px rgba(0,0,0,0.05); }
			.hero { grid-template-columns: 1fr; gap: 8px; padding: 8px 10px; }
			.hero h1 { font-size: 1.3rem; }
			.filters { margin-top: 6px; }
			.grid { grid-template-columns: 1fr; gap: 10px; }
		}
	</style>
</head>
<body>
	<div class="page">
		<div id="pageLoader" class="page-loader" aria-live="polite" aria-label="Loading shops">
			<div class="spinner"></div>
			<span id="loaderText">Loading shops…</span>
		</div>
		<div class="topbar">
			<div class="hero">
				<div class="hero-main">
					<div class="brand">
						<h1>UNM Cafeteria</h1>
					</div>
					<div class="quote-chip" id="quoteChip" aria-live="polite">Good food. Good friends. Good day.</div>
				</div>
				<div class="actions">
					<div class="profile" id="profileCard" title="Profile menu">
						<div id="profileBadge" class="profile-badge" aria-label="Profile badge">U</div>
					</div>
				</div>
			</div>
			<div class="filters">
				<input class="input" id="shopSearch" placeholder="Search shops" aria-label="Search shops" />
				<div class="filter-row">
					<div style="flex:1; min-width: 140px; color:var(--subtle); font-weight:700;">Quick filters</div>
					<div class="filter-box" aria-label="Sort and filter">
						<select id="shopSort" aria-label="Sort shops">
							<option value="asc">A-Z</option>
							<option value="desc">Z-A</option>
						</select>
						<select id="shopFilter" aria-label="Filter status">
							<option value="all">All</option>
							<option value="open">Open now</option>
							<option value="closed">Closed</option>
							<option value="fav">Favourites</option>
						</select>
					</div>
				</div>
			</div>
		</div>

		<div class="loader-wrap" id="dotLoader" aria-live="polite" aria-label="Loading shops" style="display:none;">
			<div class="dot-loader"><span></span><span></span><span></span></div>
			<span style="color:var(--subtle); font-weight:700;">Preparing menus…</span>
		</div>

		<div class="grid" id="shopList"></div>
	</div>

		<div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.28); backdrop-filter:blur(4px); z-index:20;">
			<div style="background:var(--panel); color:var(--text); width:min(360px, 92vw); margin:12vh auto; padding:22px; border-radius:16px; border:1px solid var(--stroke); box-shadow:var(--shadow); display:grid; gap:14px;">
				<div style="display:flex; justify-content:space-between; align-items:center;">
					<h2 style="margin:0; font-size:1.1rem; letter-spacing:0.6px;">Profile</h2>
					<button id="settingsClose" aria-label="Close" style="padding:8px 10px; border-radius:10px; border:1px solid var(--stroke); background:var(--panel-strong); color:var(--text); cursor:pointer;">✕</button>
				</div>
				<button id="homeLink" style="padding:11px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--panel-strong); color:var(--text); font-weight:700; text-align:left; cursor:pointer;">Home</button>
				<button id="settingsEntry" style="padding:11px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--panel-strong); color:var(--text); font-weight:700; text-align:left; cursor:pointer;">Settings</button>
				<label style="display:flex; align-items:center; justify-content:space-between; gap:12px; font-weight:700;">
					<span>Dark mode</span>
					<input type="checkbox" id="darkModeSwitch" />
				</label>
				<button id="signOutBtn" style="padding:11px 12px; border-radius:12px; border:1px solid rgba(249,115,22,0.4); background:linear-gradient(120deg, rgba(249,115,22,0.12), rgba(255,183,3,0.16)); color:var(--text); font-weight:800; letter-spacing:0.2px; cursor:pointer;">Sign out</button>
			</div>
		</div>

	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
		import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
		import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

		const firebaseConfig = {
			apiKey: "AIzaSyBQZrBURFwenjWEEnQMMIH7sOSqPq0Qtx0",
			authDomain: "unm-caf-orders.firebaseapp.com",
			projectId: "unm-caf-orders",
			storageBucket: "unm-caf-orders.appspot.com",
			messagingSenderId: "562096834985",
			appId: "1:562096834985:web:f4bfe451e5482521e49cb8",
			measurementId: "G-J12PBDK7N1"
		};

		const app = initializeApp(firebaseConfig);
		const auth = getAuth(app);
		const db = getFirestore(app);

		const shopList = document.getElementById('shopList');
		const searchInput = document.getElementById('shopSearch');
		const sortSelect = document.getElementById('shopSort');
		const filterSelect = document.getElementById('shopFilter');
		const quoteChip = document.getElementById('quoteChip');
		const profileBadge = document.getElementById('profileBadge');
		const profileCard = document.getElementById('profileCard');
		const dotLoader = document.getElementById('dotLoader');
		const pageLoader = document.getElementById('pageLoader');
		const loaderText = document.getElementById('loaderText');
		const settingsModal = document.getElementById('settingsModal');
		const darkModeSwitch = document.getElementById('darkModeSwitch');
		const homeLink = document.getElementById('homeLink');
		const settingsEntry = document.getElementById('settingsEntry');
		const signOutBtn = document.getElementById('signOutBtn');
		const vendorsRef = collection(db, 'vendors');
		const MIN_LOAD = 450;

		const setPageLoading = (on, text = 'Loading shops…') => {
			if (pageLoader) pageLoader.style.display = on ? 'flex' : 'none';
			if (loaderText) loaderText.textContent = text;
		};

		const quotes = [
			'Good food. Good friends. Good day.',
			'Grab a bite, skip the stress.',
			'Fast lines, fresh plates, full focus.',
			'Eat well now, ace it later.',
			'Campus life tastes better together.'
		];
		let quoteIndex = 0;
		function cycleQuote() {
			quoteChip.textContent = quotes[quoteIndex];
			quoteIndex = (quoteIndex + 1) % quotes.length;
		}
		cycleQuote();
		setInterval(cycleQuote, 11000);

		let shopsData = [];
		let favouriteShops = JSON.parse(localStorage.getItem('favouriteShops') || '[]');
		let isLoading = true;

		const debounce = (fn, wait = 160) => {
			let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
		};

		onAuthStateChanged(auth, user => {
			if (!user) {
				alert('Please log in first.');
				window.location.href = 'student-login.html';
				return;
			}
			if (profileBadge) {
				const initial = (user.email && user.email[0]) ? user.email[0].toUpperCase() : 'U';
				profileBadge.textContent = initial;
				profileBadge.setAttribute('aria-label', `Profile badge ${initial}`);
			}
			setPageLoading(true, 'Loading shops…');
			onSnapshot(vendorsRef, snap => handleSnapshot(snap));
		});

	if (profileCard) {
		profileCard.addEventListener('click', () => openSettings());
	}

		searchInput.addEventListener('input', debounce(render));
		sortSelect.addEventListener('change', render);
		filterSelect.addEventListener('change', render);
		document.getElementById('settingsClose').addEventListener('click', () => closeSettings());
		settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettings(); });
		darkModeSwitch.addEventListener('change', () => {
			localStorage.setItem('darkMode', darkModeSwitch.checked ? 'on' : 'off');
			applyTheme();
		});
		homeLink.addEventListener('click', () => { window.location.href = 'student-home.html'; });
		settingsEntry.addEventListener('click', () => { alert('Settings coming soon.'); });
		signOutBtn.addEventListener('click', async () => {
			setPageLoading(true, 'Signing out…');
			try { await signOut(auth); } catch (e) {}
			window.location.href = 'student-login.html';
		});

		async function handleSnapshot(snapshot) {
			isLoading = true;
			const start = Date.now();
			setPageLoading(true, 'Loading shops…');
			shopsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
			const elapsed = Date.now() - start;
			const waitTime = Math.max(MIN_LOAD - elapsed, 0);
			setTimeout(() => {
				isLoading = false;
				render();
				setPageLoading(false);
			}, waitTime);
		}

		function render() {
			if (isLoading) {
				shopList.innerHTML = '<div class="empty">Loading shops…</div>';
				return;
			}

			const term = searchInput.value.trim().toLowerCase();
			const sort = sortSelect.value;
			const filter = filterSelect.value;

			let data = shopsData.slice();
			if (term) data = data.filter(s => (s.name || '').toLowerCase().includes(term));
			if (filter === 'open') data = data.filter(s => s.isOpen);
			if (filter === 'closed') data = data.filter(s => !s.isOpen);
			if (filter === 'fav') data = data.filter(s => favouriteShops.includes(s.id));

			data.sort((a, b) => sort === 'desc' ? b.name.localeCompare(a.name) : a.name.localeCompare(b.name));

			if (!data.length) {
				shopList.innerHTML = '<div class="empty">No shops match right now.</div>';
				return;
			}

			const frag = document.createDocumentFragment();
			data.forEach(shop => frag.appendChild(buildCard(shop)));
			shopList.replaceChildren(frag);
		}

		function buildCard(shop) {
			const card = document.createElement('article');
			card.className = 'card';
			card.dataset.shopid = shop.id;
			card.dataset.isOpen = shop.isOpen ? 'true' : 'false';

			const imgWrap = document.createElement('div');
			const img = document.createElement('img');
			img.loading = 'lazy';
			img.decoding = 'async';
			img.src = shop.imageURL || 'https://via.placeholder.com/600x320?text=Menu+coming+soon';
			img.alt = `${shop.name || 'Shop'} cover`;
			imgWrap.append(img);

			const body = document.createElement('div');
			body.className = 'card-body';

			const head = document.createElement('div');
			head.className = 'card-head';
			const h3 = document.createElement('h3');
			h3.textContent = shop.name || 'Shop';
			const status = document.createElement('span');
			status.className = `status ${shop.isOpen ? 'open' : 'closed'}`;
			status.textContent = shop.isOpen ? 'Open' : 'Closed';
			head.append(h3, status);

			const desc = document.createElement('p');
			desc.textContent = shop.description || 'Menu details coming soon.';

			const foot = document.createElement('div');
			foot.className = 'card-foot';
			const cta = document.createElement('div');
			cta.className = 'cta';
			cta.textContent = shop.isOpen ? 'View menu' : 'Preview menu';
			foot.append(cta);

			body.append(head, desc, foot);

			const fav = document.createElement('button');
			fav.type = 'button';
			fav.className = 'fav-btn' + (favouriteShops.includes(shop.id) ? ' fav' : '');
			fav.setAttribute('aria-label', 'Toggle favourite');
			fav.dataset.shopid = shop.id;
			fav.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21.35l-1.45-1.32C5.2 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.2 6.86-8.55 11.54L12 21.35z"/></svg>';

			card.append(imgWrap, body, fav);
			return card;
		}

		// Delegate clicks to reduce per-card listeners
		shopList.addEventListener('click', e => {
			const favBtn = e.target.closest('.fav-btn');
			if (favBtn) {
				e.stopPropagation();
				const id = favBtn.dataset.shopid;
				if (id) toggleFavourite(id);
				return;
			}
			const card = e.target.closest('.card');
			if (card && card.dataset.isOpen === 'true') {
				const vendor = card.dataset.shopid;
				if (vendor) window.location.href = `menu.html?vendor=${vendor}`;
			}
		});

		function toggleFavourite(id) {
			const idx = favouriteShops.indexOf(id);
			if (idx === -1) favouriteShops.push(id); else favouriteShops.splice(idx, 1);
			localStorage.setItem('favouriteShops', JSON.stringify(favouriteShops));
			render();
		}

		function renderSkeletons(count = 6) {
			const frag = document.createDocumentFragment();
			for (let i = 0; i < count; i++) {
				const sk = document.createElement('div');
				sk.className = 'skeleton';
				sk.innerHTML = `
					<div class="sk-img"></div>
					<div class="sk-body">
						<div class="sk-line" style="width:70%"></div>
						<div class="sk-line" style="width:92%"></div>
						<div class="sk-pill"></div>
					</div>`;
				frag.appendChild(sk);
			}
			shopList.replaceChildren(frag);
		}

		function toggleLoader(show) { dotLoader.style.display = show ? 'flex' : 'none'; }
		function wait() { return Promise.resolve(); }
		async function preloadImages() { return; }

		function applyTheme() {
			const mode = localStorage.getItem('darkMode') || 'off';
			darkModeSwitch.checked = mode === 'on';
			if (mode === 'on') document.body.classList.add('dark-mode'); else document.body.classList.remove('dark-mode');
		}

		function openSettings() {
			settingsModal.style.display = 'block';
			darkModeSwitch.checked = localStorage.getItem('darkMode') === 'on';
		}

		function closeSettings() {
			settingsModal.style.display = 'none';
		}

		applyTheme();
	</script>
</body>
</html>
