<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vendor Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='6' y='6' width='52' height='52' rx='12' ry='12' fill='%23fff' stroke='%23f97316' stroke-width='2'/%3E%3Cpath fill='%23f97316' d='M18 14c4.2 0 7.6 3.4 7.6 7.6 0 3.2-1.8 6-4.6 7.1V46h-6V28.7c-2.8-1.1-4.6-3.9-4.6-7.1C10.4 17.4 13.8 14 18 14z'/%3E%3Cpath fill='%23ea580c' d='M34 14h4v10h2V14h4v10h2V14h4v12h-6v20h-6V26h-6z'/%3E%3C/svg%3E" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --surface: #ffffff;
      --surface-strong: #f8fafc;
      --ink: #0f172a;
      --muted: #475569;
      --brand: #f97316;
      --brand-strong: #ea580c;
      --teal: #0ea5e9;
      --border: #e2e8f0;
      --shadow: 0 12px 32px rgba(0,0,0,0.08);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: 'Inter', 'Space Grotesk', 'Segoe UI', Arial, sans-serif;
      color: var(--ink);
      background: #0f172a;
    }

    .background {
      position: fixed;
      inset: 0;
      z-index: -2;
      background: radial-gradient(circle at 20% 20%, rgba(14,165,233,0.25), transparent 32%),
                  radial-gradient(circle at 80% 10%, rgba(249,115,22,0.22), transparent 30%),
                  radial-gradient(circle at 70% 70%, rgba(56,189,248,0.18), transparent 34%),
                  #0b1220;
    }

    .shell {
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px clamp(14px, 3vw, 24px) 32px;
    }

    .vendor-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      padding: 18px;
      background: linear-gradient(140deg, rgba(249,115,22,0.12), rgba(14,165,233,0.12)), var(--surface);
      border: 1px solid rgba(226,232,240,0.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .hero-left { display: flex; align-items: center; gap: 14px; }

    #vendor-logo {
      width: 82px;
      height: 82px;
      border-radius: 18px;
      object-fit: cover;
      border: 2px solid #cbd5e1;
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      background: var(--surface-strong);
    }

    .hero-meta { display: grid; gap: 6px; }

    .eyebrow { margin: 0; color: var(--muted); font-weight: 700; letter-spacing: 0.3px; font-size: 0.9rem; }

    .hero-title {
      margin: 0;
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      font-weight: 700;
      letter-spacing: 0.3px;
      color: var(--ink);
    }

    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 999px; border: 1px solid var(--border); background: var(--surface-strong); font-weight: 700; color: var(--muted); font-size: 0.9rem; }
    .chip.positive { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .chip.negative { background: #fee2e2; color: #b91c1c; border-color: #fecdd3; }

    .toolbar {
      margin: 16px 0 18px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .stat-card {
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 18px rgba(0,0,0,0.06);
      display: grid;
      gap: 6px;
    }
    .stat-label { color: var(--muted); font-weight: 700; }
    .stat-value { font-size: 1.6rem; font-weight: 800; color: var(--brand-strong); }

    .toolbar-actions { display: flex; gap: 10px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }

    .btn { border: 1px solid transparent; border-radius: 12px; padding: 10px 14px; font-weight: 800; letter-spacing: 0.2px; cursor: pointer; transition: transform 0.12s ease, box-shadow 0.16s ease, background 0.16s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: linear-gradient(120deg, var(--brand) 0%, var(--brand-strong) 100%); color: #fff; box-shadow: 0 12px 22px rgba(234,88,12,0.25); }
    .btn.primary:hover { box-shadow: 0 16px 28px rgba(234,88,12,0.3); }
    .btn.outline { background: var(--surface); color: var(--ink); border-color: var(--border); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    .btn.outline:hover { border-color: #cbd5e1; }
    .btn.danger { background: linear-gradient(120deg, #ef4444, #f97316); color: #fff; box-shadow: 0 12px 24px rgba(239,68,68,0.2); }
    .btn.danger.open { background: linear-gradient(120deg, #22c55e, #0ea5e9); box-shadow: 0 12px 24px rgba(34,197,94,0.2); }
    .btn:disabled { opacity: 0.65; cursor: not-allowed; }

    .orders-grid { display: grid; gap: 14px; }

    .order-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      display: grid;
      gap: 12px;
    }

    .order-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
    .order-meta { display: grid; gap: 4px; }
    .order-date { color: var(--muted); font-weight: 700; }
    .pill-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 10px; font-weight: 800; letter-spacing: 0.2px; border: 1px solid var(--border); background: var(--surface-strong); color: var(--muted); }
    .pill.status-ready { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .pill.status-pending { background: #fff7ed; color: #c2410c; border-color: #fed7aa; }
    .pill.delivery-dine-in { background: #e0f2fe; color: #075985; border-color: #bae6fd; }
    .pill.delivery-take-away { background: #ffe4e6; color: #9f1239; border-color: #fecdd3; }

    .item-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 10px; }
    .item-row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid #f1f5f9; border-radius: 12px; background: #f8fafc; }
    .item-name { font-weight: 800; color: var(--ink); }
    .item-qty { font-weight: 800; color: #b91c1c; background: #fee2e2; border-radius: 10px; padding: 4px 12px; border: 1px solid #fecdd3; }
    .item-meta { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px; }
    .item-note { background: #fff7ed; color: #c2410c; border-radius: 10px; padding: 6px 10px; border: 1px solid #fed7aa; font-weight: 700; }

    .order-total { text-align: right; font-weight: 800; color: var(--brand-strong); font-size: 1.1rem; }

    .order-note-block { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px 12px; display: grid; gap: 4px; color: var(--ink); }
    .order-note-block span { font-weight: 800; color: var(--muted); }

    .order-card button {
      justify-self: flex-end;
      min-width: 180px;
    }

    @media (max-width: 720px) {
      .vendor-hero { flex-direction: column; align-items: flex-start; }
      .toolbar-actions { justify-content: flex-start; }
      .order-top { flex-direction: column; align-items: flex-start; }
      .pill-row { justify-content: flex-start; }
      .item-row { grid-template-columns: 1fr; }
      .order-card button { width: 100%; justify-self: stretch; }
    }
  </style>
</head>
<body>
  <div class="background"></div>
  <main class="shell">
    <header class="vendor-hero">
      <div class="hero-left">
        <img id="vendor-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' rx='18' fill='%23e2e8f0'/%3E%3Cpath d='M34 86L58 34h4l24 52h-9l-4.8-11H47.8L43 86h-9zM50.6 67.2h18.8L60 49.4z' fill='%2394a3b8'/%3E%3C/svg%3E" alt="Vendor Logo">
        <div class="hero-meta">
          <p class="eyebrow">Vendor dashboard</p>
          <h1 id="vendor-name" class="hero-title">Vendor Dashboard</h1>
          <div><span id="shop-status" class="chip">Loading status‚Ä¶</span></div>
        </div>
      </div>
    </header>

    <section class="toolbar">
      <div class="stat-card">
        <div class="stat-label">Orders processed</div>
        <div class="stat-value" id="orderCount">0</div>
      </div>
      <div class="toolbar-actions">
        <button class="btn outline" onclick="window.location.href='menu-management.html?vendor=' + window.vendorId">Manage menu</button>
        <button class="btn danger" id="close-shop-btn">Close shop</button>
      </div>
    </section>

    <section id="orders-container" class="orders-grid"></section>
  </main>

  <!-- Legacy audio fallback (kept for compatibility, main alert uses Web Audio) -->
  <audio id="ding-sound" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, onSnapshot, updateDoc, doc, getDoc, increment, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBQZrBURFwenjWEEnQMMIH7sOSqPq0Qtx0",
      authDomain: "unm-caf-orders.firebaseapp.com",
      projectId: "unm-caf-orders",
      storageBucket: "unm-caf-orders.appspot.com",
      messagingSenderId: "562096834985",
      appId: "1:562096834985:web:f4fbe451e5482521e49cb8",
      measurementId: "G-J12PBDK7N1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const vendorId = urlParams.get("vendor");
    window.vendorId = vendorId;
    const ordersContainer = document.getElementById("orders-container");
    const dingSound = document.getElementById("ding-sound");
    const closeShopBtn = document.getElementById("close-shop-btn");
    const shopStatusChip = document.getElementById("shop-status");
    const orderCountEl = document.getElementById("orderCount");
    const vendorRef = doc(db, "vendors", vendorId);
    const defaultLogo = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' rx='18' fill='%23e2e8f0'/%3E%3Cpath d='M34 86L58 34h4l24 52h-9l-4.8-11H47.8L43 86h-9zM50.6 67.2h18.8L60 49.4z' fill='%2394a3b8'/%3E%3C/svg%3E";

    // Track and control the repeated alarm loop for new orders
    let alertTimeout = null;
    let alertTimers = [];
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let activeOsc = null;
    let activeGain = null;

    function stopTone() {
      try { if (activeOsc) activeOsc.stop(); } catch (_) {}
      activeOsc = null;
      activeGain = null;
      if (alertTimeout) {
        clearTimeout(alertTimeout);
        alertTimeout = null;
      }
      alertTimers.forEach(t => clearTimeout(t));
      alertTimers = [];
    }

    function playNewOrderAlert() {
      if (!AudioCtx) return;
      stopTone();
      if (!audioCtx) audioCtx = new AudioCtx();
      if (audioCtx.state === "suspended") audioCtx.resume();

      // Softer triad, repeated a few times for visibility
      const playTriad = () => {
        const notes = [587.33, 659.25, 783.99]; // D5, E5, G5
        const now = audioCtx.currentTime;
        notes.forEach((freq, idx) => {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.type = "sine";
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.0, now);
          gain.gain.linearRampToValueAtTime(0.06, now + 0.01);
          gain.gain.linearRampToValueAtTime(0.0, now + 0.6 + idx * 0.1);
          osc.connect(gain).connect(audioCtx.destination);
          osc.start(now + idx * 0.1);
          osc.stop(now + 0.65 + idx * 0.1);
          if (idx === 0) {
            activeOsc = osc;
            activeGain = gain;
          }
        });
      };

      const repeats = 4;
      const spacingMs = 1300; // gap between repeats so each plays cleanly
      playTriad();
      for (let i = 1; i < repeats; i++) {
        const timer = setTimeout(playTriad, i * spacingMs);
        alertTimers.push(timer);
      }

      alertTimeout = setTimeout(() => {
        stopTone();
      }, repeats * spacingMs + 800);
    }

    // Audio now attempts to play automatically when new orders arrive.

    // Helper: is this a cold beverage?
    function isColdBeverage(item) {
      return item.category === "Beverages" && item.name && item.name.endsWith(" (Cold)");
    }

    // Categories that do NOT get takeaway fee
    const NO_TAKEAWAY_FEE_CATEGORIES = [
      "Cold Drink", "Fresh Juice", "Hicknokey", "Other Drink"
    ];

    // Calculate total amount for an order
    function calculateOrderTotal(items, deliveryOption) {
      let total = 0;
      items.forEach(item => {
        let fee = 0;
        if (deliveryOption === "take-away") {
          if (item.category === "Beverages") {
            if (!isColdBeverage(item)) {
              fee = 1.0;
            }
          } else if (!NO_TAKEAWAY_FEE_CATEGORIES.some(cat =>
            (item.category || "").toLowerCase() === cat.toLowerCase()
          )) {
            fee = 1.0;
          }
        }
        total += item.qty * item.price + fee;
      });
      return total;
    }

    // Format Firestore Timestamp to readable date/time
    function formatDate(ts) {
      if (!ts) return "--";
      let dateObj;
      if (ts instanceof Timestamp) {
        dateObj = ts.toDate();
      } else if (ts.seconds) {
        dateObj = new Date(ts.seconds * 1000);
      } else {
        dateObj = new Date(ts);
      }
      return dateObj.toLocaleString();
    }

    // Render each order
    function renderOrder(docSnap) {
      const data = docSnap.data();
      const div = document.createElement("div");
      div.className = "order-card";

      const orderDate = formatDate(data.createdAt);
      const orderTotal = calculateOrderTotal(data.items || [], data.deliveryOption);
      const deliveryOption = data.deliveryOption ? data.deliveryOption.charAt(0).toUpperCase() + data.deliveryOption.slice(1) : "--";
      const emoji = data.deliveryOption === "dine-in" ? "üçΩÔ∏è" : data.deliveryOption === "take-away" ? "üõçÔ∏è" : "";
      const isReady = data.status === "Ready";
      const statusClass = isReady ? "status-ready" : "status-pending";

      const itemsMarkup = (data.items || []).map((item) => {
        const selections = (item.selections || []).map((sel) => `<span class="chip">${sel.label || "Choice"}: ${sel.value || sel.label || ""}</span>`).join("");
        const noteLine = item.notes ? `<span class="item-note">üìù ${item.notes}</span>` : "";
        const meta = selections || noteLine ? `<div class="item-meta">${selections}${noteLine}</div>` : "";
        return `
          <li class="item-row">
            <div>
              <div class="item-name">${item.name || "Item"}</div>
              ${meta}
            </div>
            <div class="item-qty">√ó ${item.qty || 0}</div>
          </li>
        `;
      }).join("");

      const orderNoteBlock = data.note ? `
        <div class="order-note-block">
          <span>Order note</span>
          <p>${data.note}</p>
        </div>
      ` : "";

      div.innerHTML = `
        <div class="order-top">
          <div class="order-meta">
            <div class="item-name">Order #${data.orderNumber || "--"}</div>
            <div class="order-date">${orderDate}</div>
          </div>
          <div class="pill-row">
            <span class="pill ${statusClass}">${isReady ? "Ready" : data.status || "Pending"}</span>
            <span class="pill delivery-${data.deliveryOption || ""}">${emoji} ${deliveryOption}</span>
          </div>
        </div>
        <ul class="item-list">${itemsMarkup}</ul>
        <div class="order-total">Total: RM ${orderTotal.toFixed(2)}</div>
        ${orderNoteBlock}
        <button 
          class="btn primary"
          data-order="${docSnap.id}" 
          onclick="markReady('${docSnap.id}')"
          ${isReady ? "disabled" : ""}>
          ${isReady ? "Marked as ready" : "Mark as ready"}
        </button>
      `;
      ordersContainer.appendChild(div);
    }

    // Mark order as ready
    window.markReady = async function (orderId) {
      const orderRef = doc(db, "orders", orderId);
      try {
        await updateDoc(orderRef, { status: "Ready" });
      } catch (err) {
        console.error("‚ùå Failed to update order:", err);
      }
    }

    // Update badge showing shop open/closed
    function setShopStatusChip(isOpen) {
      if (!shopStatusChip) return;
      shopStatusChip.textContent = isOpen ? "Open for orders" : "Closed";
      shopStatusChip.classList.toggle("positive", isOpen);
      shopStatusChip.classList.toggle("negative", !isOpen);
    }

    // Update shop button UI and logic
    function updateShopButton(isOpen) {
      setShopStatusChip(isOpen);
      closeShopBtn.textContent = isOpen ? "Close shop" : "Open shop";
      closeShopBtn.classList.toggle("open", !isOpen);
      if (isOpen) {
        closeShopBtn.onclick = async function() {
          if (confirm("Are you sure you want to close the shop? Customers will not be able to order.")) {
            await updateDoc(vendorRef, { isOpen: false });
            alert("Shop is now closed.");
            updateShopButton(false);
          }
        };
      } else {
        closeShopBtn.onclick = async function() {
          if (confirm("Are you sure you want to open the shop? Customers will be able to order.")) {
            await updateDoc(vendorRef, { isOpen: true });
            alert("Shop is now open.");
            updateShopButton(true);
          }
        };
      }
    }

    // Load vendor info and update shop button
    async function loadVendorInfo() {
      const vendorSnap = await getDoc(vendorRef);
      if (vendorSnap.exists()) {
        const data = vendorSnap.data();
        document.getElementById("vendor-name").textContent = data.name || "Vendor Dashboard";
        document.getElementById("vendor-logo").src = data.imageURL || defaultLogo;
        document.getElementById("orderCount").textContent = data.orderCount || 0;
        updateShopButton(data.isOpen !== false);
        setShopStatusChip(data.isOpen !== false);
      }
    }

    // Listen for orders
    let firstLoad = true;
    const q = query(collection(db, "orders"), where("vendorId", "==", vendorId), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
      if (!firstLoad) {
        playNewOrderAlert();
      }
      firstLoad = false;

      ordersContainer.innerHTML = "";
      snapshot.forEach(doc => renderOrder(doc));

      // Update processed count without touching vendor doc to avoid student reloads
      const readyCount = snapshot.docs.filter(d => (d.data().status || "") === "Ready").length;
      if (orderCountEl) orderCountEl.textContent = readyCount;
    });

    loadVendorInfo();
  </script>
</body>
</html>
