<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Shop Control Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: #222;
      background: transparent;
    }
    .background {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-image: url('https://www.nottingham.edu.my/events/images-multimedia/25th-anniversary/banner-homepage-25th-anniversary.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(6px) brightness(0.7);
      z-index: -1;
    }
    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      padding: 32px 24px;
      position: relative;
      z-index: 1;
    }
    h1 {
      text-align: center;
      font-size: 2.2rem;
      color: #005f73;
      margin-bottom: 18px;
      font-weight: 900;
      letter-spacing: 1px;
    }
    .controls {
      display: flex;
      gap: 18px;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .controls input[type="date"], .controls input[type="text"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #bbb;
      font-size: 1rem;
      outline: none;
    }
    .controls button {
      padding: 8px 18px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #005f73 60%, #00aaff 100%);
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s;
    }
    .controls button:hover {
      background: linear-gradient(90deg, #00aaff 60%, #005f73 100%);
    }
    .shop-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .shop-table th, .shop-table td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .shop-table th {
      background: #e0f7fa;
      color: #005f73;
      font-weight: 700;
      font-size: 1.05rem;
    }
    .shop-table tr:last-child td {
      border-bottom: none;
    }
    .shop-status {
      font-weight: bold;
      padding: 4px 12px;
      border-radius: 8px;
      color: #fff;
      display: inline-block;
    }
    .shop-status.open {
      background: linear-gradient(90deg, #28a745 60%, #4caf50 100%);
    }
    .shop-status.closed {
      background: linear-gradient(90deg, #d32f2f 60%, #ff6f6f 100%);
    }
    .action-btn {
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.98rem;
      margin-right: 6px;
      transition: background 0.2s;
    }
    .action-btn.open {
      background: linear-gradient(90deg, #28a745 60%, #4caf50 100%);
      color: #fff;
    }
    .action-btn.close {
      background: linear-gradient(90deg, #d32f2f 60%, #ff6f6f 100%);
      color: #fff;
    }
    .action-btn:disabled {
      background: #ccc;
      color: #888;
      cursor: not-allowed;
    }
    .logout-btn {
      position: absolute;
      top: 24px;
      right: 32px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 2px 8px #d32f2f44;
      transition: background 0.2s;
    }
    .logout-btn:hover {
      background: #ff6f6f;
      color: #d32f2f;
    }
    .summary {
      margin-bottom: 18px;
      font-size: 1.1rem;
      color: #005f73;
      font-weight: bold;
      text-align: center;
    }
    @media (max-width: 900px) {
      .container {
        max-width: 98vw;
        padding: 18px 4vw;
      }
      .logout-btn {
        right: 10px;
      }
    }
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .container {
        padding: 8px 2vw;
      }
      .logout-btn {
        top: 10px;
        right: 10px;
        padding: 7px 12px;
        font-size: 0.95rem;
      }
      .shop-table th, .shop-table td {
        padding: 8px 4px;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>
  <div class="background"></div>
  <button class="logout-btn" id="logoutBtn" style="display:none;">Logout</button>
  <div class="container" id="mainContainer" style="display:none;">
    <h1>Admin Shop Control Dashboard</h1>
    <div class="summary" id="summary"></div>
    <div class="controls">
      <input type="date" id="datePicker">
      <input type="text" id="shopSearch" placeholder="Search shop...">
      <button id="refreshBtn">Refresh</button>
    </div>
    <table class="shop-table" id="shopTable">
      <thead>
        <tr>
          <th>Shop</th>
          <th>Status</th>
          <th>Orders Today</th>
          <th>Orders This Month</th>
          <th>Charge (RM)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="shopTableBody"></tbody>
    </table>
  </div>
  <div id="loginContainer" style="max-width:400px;margin:80px auto;padding:32px 24px;background:#fff;border-radius:18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);text-align:center;">
    <h2 style="color:#005f73;">Admin Login</h2>
    <input type="email" id="emailInput" placeholder="Email" style="width:90%;padding:10px;margin:10px 0;border-radius:8px;border:1px solid #bbb;font-size:1rem;">
    <input type="password" id="passwordInput" placeholder="Password" style="width:90%;padding:10px;margin:10px 0;border-radius:8px;border:1px solid #bbb;font-size:1rem;">
    <button id="loginBtn" style="padding:10px 24px;border-radius:8px;background:linear-gradient(90deg,#005f73 60%,#00aaff 100%);color:white;font-weight:bold;font-size:1rem;border:none;cursor:pointer;">Login</button>
    <div id="loginError" style="color:#d32f2f;margin-top:10px;"></div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, collection, getDocs, updateDoc, doc, query, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // CONFIG
    const ADMIN_EMAIL = "absmods538@gmail.com"; // <-- your email

    const firebaseConfig = {
      apiKey: "AIzaSyBQZrBURFwenjWEEnQMMIH7sOSqPq0Qtx0",
      authDomain: "unm-caf-orders.firebaseapp.com",
      projectId: "unm-caf-orders",
      storageBucket: "unm-caf-orders.appspot.com",
      messagingSenderId: "562096834985",
      appId: "1:562096834985:web:f4bfe451e5482521e49cb8",
      measurementId: "G-J12PBDK7N1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elements
    const loginContainer = document.getElementById("loginContainer");
    const mainContainer = document.getElementById("mainContainer");
    const loginBtn = document.getElementById("loginBtn");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const loginError = document.getElementById("loginError");
    const logoutBtn = document.getElementById("logoutBtn");
    const shopTableBody = document.getElementById("shopTableBody");
    const datePicker = document.getElementById("datePicker");
    const shopSearch = document.getElementById("shopSearch");
    const refreshBtn = document.getElementById("refreshBtn");
    const summary = document.getElementById("summary");

    // Login logic
    loginBtn.onclick = async () => {
      loginError.textContent = "";
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (email !== ADMIN_EMAIL) {
        loginError.textContent = "Access denied.";
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        loginError.textContent = "Login failed.";
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
      mainContainer.style.display = "none";
      loginContainer.style.display = "block";
      logoutBtn.style.display = "none";
    };

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user && user.email === ADMIN_EMAIL) {
        loginContainer.style.display = "none";
        mainContainer.style.display = "block";
        logoutBtn.style.display = "block";
        loadShops();
      } else {
        mainContainer.style.display = "none";
        loginContainer.style.display = "block";
        logoutBtn.style.display = "none";
      }
    });

    // Load shops and orders
    async function loadShops() {
      const selectedDate = datePicker.value ? new Date(datePicker.value) : new Date();
      selectedDate.setHours(0,0,0,0);
      const nextDate = new Date(selectedDate);
      nextDate.setDate(selectedDate.getDate() + 1);

      // Month range
      const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
      const monthEnd = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1);

      const vendorsSnap = await getDocs(collection(db, "vendors"));
      const shops = [];
      vendorsSnap.forEach(docSnap => {
        const data = docSnap.data();
        shops.push({
          id: docSnap.id,
          name: data.name,
          isOpen: data.isOpen !== false,
          orderCount: data.orderCount || 0
        });
      });

      // Orders today
      const ordersSnap = await getDocs(query(
        collection(db, "orders"),
        where("createdAt", ">=", Timestamp.fromDate(selectedDate)),
        where("createdAt", "<", Timestamp.fromDate(nextDate))
      ));
      const ordersByShop = {};
      ordersSnap.forEach(orderDoc => {
        const order = orderDoc.data();
        if (!ordersByShop[order.vendorId]) ordersByShop[order.vendorId] = 0;
        ordersByShop[order.vendorId]++;
      });

      // Orders this month
      const monthOrdersSnap = await getDocs(query(
        collection(db, "orders"),
        where("createdAt", ">=", Timestamp.fromDate(monthStart)),
        where("createdAt", "<", Timestamp.fromDate(monthEnd))
      ));
      const monthOrdersByShop = {};
      monthOrdersSnap.forEach(orderDoc => {
        const order = orderDoc.data();
        if (!monthOrdersByShop[order.vendorId]) monthOrdersByShop[order.vendorId] = 0;
        monthOrdersByShop[order.vendorId]++;
      });

      // Filter by search
      const search = shopSearch.value.trim().toLowerCase();
      const filteredShops = shops.filter(shop =>
        shop.name && shop.name.toLowerCase().includes(search)
      );

      // Summary
      summary.textContent = `Total Shops: ${shops.length} | Open: ${shops.filter(s=>s.isOpen).length} | Orders Today: ${ordersSnap.size} | Orders This Month: ${monthOrdersSnap.size}`;

      // Render table
      shopTableBody.innerHTML = "";
      filteredShops.forEach(shop => {
        const ordersMonth = monthOrdersByShop[shop.id] || 0;
        const charge = (ordersMonth * 0.3).toFixed(2);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${shop.name}</td>
          <td>
            <span class="shop-status ${shop.isOpen ? 'open' : 'closed'}">
              ${shop.isOpen ? 'Open' : 'Closed'}
            </span>
          </td>
          <td>${ordersByShop[shop.id] || 0}</td>
          <td>${ordersMonth}</td>
          <td>RM ${charge}</td>
          <td>
            <button class="action-btn ${shop.isOpen ? 'close' : 'open'}" data-id="${shop.id}" data-action="${shop.isOpen ? 'close' : 'open'}">
              ${shop.isOpen ? 'Close Shop' : 'Open Shop'}
            </button>
            <button class="action-btn" style="background:#00aaff;color:#fff;" onclick="window.open('menu-management.html?vendor=${shop.id}','_blank')">Menu</button>
          </td>
        `;
        shopTableBody.appendChild(tr);
      });

      // Add open/close handlers
      document.querySelectorAll('.action-btn[data-action]').forEach(btn => {
        btn.onclick = async function() {
          const shopId = btn.getAttribute('data-id');
          const action = btn.getAttribute('data-action');
          const vendorRef = doc(db, "vendors", shopId);
          await updateDoc(vendorRef, { isOpen: action === "open" });
          loadShops();
        };
      });
    }

    datePicker.valueAsDate = new Date();
    datePicker.onchange = loadShops;
    shopSearch.oninput = loadShops;
    refreshBtn.onclick = loadShops;
  </script>
</body>
</html>
